<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bookstore.mapper.BookMapper">
    <insert id="insert" parameterType="com.bookstore.entity.Book">
        INSERT INTO `book` (`isbn`, `book_name`, `author`, `publisher`, `price`, `stock_num`, `sold_num`, `introduction`, `cover_image`, `is_active`, `book_type`)
        VALUES (#{ISBN}, #{bookName}, #{author}, #{publisher}, #{price}, #{stockNum}, #{soldNum}, #{introduction}, #{coverImage}, #{isActive}, #{bookType})
    </insert>
    
    <select id="selectById" resultType="com.bookstore.entity.Book" parameterType="java.lang.Integer">
        SELECT `book_id` as bookId, `isbn` as ISBN, `book_name` as bookName, `author`, `publisher`, `price`, `stock_num` as stockNum, `sold_num` as soldNum, `introduction`, `cover_image` as coverImage, `is_active` as isActive, `book_type` as bookType
        FROM `book`
        WHERE `book_id` = #{bookId}
    </select>
    
    <select id="selectAll" resultType="com.bookstore.entity.Book">
        SELECT `book_id` as bookId, `isbn` as ISBN, `book_name` as bookName, `author`, `publisher`, `price`, `stock_num` as stockNum, `sold_num` as soldNum, `introduction`, `cover_image` as coverImage, `is_active` as isActive, `book_type` as bookType
        FROM `book`
    </select>
    
    <select id="selectActive" resultType="com.bookstore.entity.Book">
        SELECT `book_id` as bookId, `isbn` as ISBN, `book_name` as bookName, `author`, `publisher`, `price`, `stock_num` as stockNum, `sold_num` as soldNum, `introduction`, `cover_image` as coverImage, `is_active` as isActive, `book_type` as bookType
        FROM `book`
        WHERE `is_active` = true
    </select>
    
    <!-- 搜索图书 -->
    <select id="searchBooks" resultType="com.bookstore.entity.Book" parameterType="java.lang.String">
        SELECT `book_id` as bookId, `isbn` as ISBN, `book_name` as bookName, `author`, `publisher`, `price`, `stock_num` as stockNum, `sold_num` as soldNum, `introduction`, `cover_image` as coverImage, `book_type` as bookType, `is_active` as isActive
        FROM `book`
        WHERE `is_active` = true
        AND (`book_name` LIKE CONCAT('%', #{keyword}, '%')
        OR `author` LIKE CONCAT('%', #{keyword}, '%')
        OR `isbn` LIKE CONCAT('%', #{keyword}, '%')
        OR `publisher` LIKE CONCAT('%', #{keyword}, '%')
        OR `introduction` LIKE CONCAT('%', #{keyword}, '%'))
    </select>
    
    <update id="update" parameterType="com.bookstore.entity.Book">
        UPDATE `book`
        SET `isbn` = #{ISBN}, `book_name` = #{bookName}, `author` = #{author}, `publisher` = #{publisher}, `price` = #{price}, `stock_num` = #{stockNum}, `sold_num` = #{soldNum}, `introduction` = #{introduction}, `cover_image` = #{coverImage}, `is_active` = #{isActive}, `book_type` = #{bookType}
        WHERE `book_id` = #{bookId}
    </update>
    
    <update id="updateStock" parameterType="java.lang.Integer">
        UPDATE `book`
        SET `stock_num` = `stock_num` - #{quantity}, `sold_num` = `sold_num` + #{quantity}
        WHERE `book_id` = #{bookId}
    </update>
    
    <delete id="delete" parameterType="java.lang.Integer">
        DELETE FROM `book`
        WHERE `book_id` = #{bookId}
    </delete>
    
    <!-- 获取总图书数量 -->
    <select id="getTotalBookCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM `book` WHERE `is_active` = true
    </select>
    
    <!-- 按类别查询图书 -->
    <select id="selectByType" resultType="com.bookstore.entity.Book" parameterType="java.lang.Integer">
        SELECT `book_id` as bookId, `isbn` as ISBN, `book_name` as bookName, `author`, `publisher`, `price`, `stock_num` as stockNum, `sold_num` as soldNum, `introduction`, `cover_image` as coverImage, `is_active` as isActive, `book_type` as bookType
        FROM `book`
        WHERE `is_active` = true AND `book_type` = #{bookType}
    </select>
    
    <!-- 随机获取指定数量的图书（用于图书秒杀） -->
    <select id="selectRandomBooks" resultType="com.bookstore.entity.Book" parameterType="java.lang.Integer">
        SELECT `book_id` as bookId, `isbn` as ISBN, `book_name` as bookName, `author`, `publisher`, `price`, `stock_num` as stockNum, `sold_num` as soldNum, `introduction`, `cover_image` as coverImage, `is_active` as isActive, `book_type` as bookType
        FROM `book`
        WHERE `is_active` = true AND `stock_num` > 0
        ORDER BY RAND()
        LIMIT #{limit}
    </select>
    
    <!-- 获取评分最高的图书（用于精选图书） -->
    <select id="selectTopRatedBooks" resultType="com.bookstore.entity.Book" parameterType="java.lang.Integer">
        SELECT b.`book_id` as bookId, b.`isbn` as ISBN, b.`book_name` as bookName, b.`author`, b.`publisher`, b.`price`, b.`stock_num` as stockNum, b.`sold_num` as soldNum, b.`introduction`, b.`cover_image` as coverImage, b.`is_active` as isActive, b.`book_type` as bookType
        FROM `book` b
        LEFT JOIN `comment` c ON b.`book_id` = c.`book_id`
        WHERE b.`is_active` = true
        GROUP BY b.`book_id`
        ORDER BY COALESCE(AVG(c.`rating`), 0) DESC
        LIMIT #{limit}
    </select>
    
    <!-- 获取最新添加的图书（用于新书推荐） -->
    <select id="selectNewestBooks" resultType="com.bookstore.entity.Book" parameterType="java.lang.Integer">
        SELECT `book_id` as bookId, `isbn` as ISBN, `book_name` as bookName, `author`, `publisher`, `price`, `stock_num` as stockNum, `sold_num` as soldNum, `introduction`, `cover_image` as coverImage, `is_active` as isActive, `book_type` as bookType
        FROM `book`
        WHERE `is_active` = true
        ORDER BY `book_id` DESC
        LIMIT #{limit}
    </select>
</mapper>